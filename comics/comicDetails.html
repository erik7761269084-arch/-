<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Comic Viewer</title>

<style>
html,body{
    margin:0;padding:0;height:100%;
    background:#111;color:#fff;
    font-family:"Microsoft YaHei",sans-serif;
}
#viewer{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
}

/* 翻页模式 */
.page-img{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%) scale(1);
    max-width:100%;
    max-height:100%;
    display:none;
    touch-action:none;
}

/* 下拉模式 */
.scroll-mode{
    height:100%;
    overflow-y:auto;
}
.scroll-img{
    display:block;
    max-width:100%;
    margin:0 auto 14px;
}

/* 翻页按钮 */
.nav-btn{
    position:fixed;
    top:50%;
    transform:translateY(-50%);
    background:rgba(0,0,0,.6);
    border:none;
    color:#fff;
    font-size:22px;
    padding:10px;
    border-radius:6px;
    z-index:1002;
    display:none;
}
#prev{left:10px;}
#next{right:10px;}

/* 模式切换 */
#modeBtn{
    position:fixed;
    top:12px;
    right:12px;
    background:rgba(0,0,0,.75);
    padding:6px 14px;
    border-radius:20px;
    cursor:pointer;
    z-index:1003;
}

/* 预览 */
#bottomBar{
    position:fixed;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.7);
    padding:8px 20px;
    border-radius:14px 14px 0 0;
    cursor:pointer;
    z-index:1001;
}
#preview{
    position:fixed;
    bottom:-120px;
    left:0;
    width:100%;
    height:110px;
    background:rgba(0,0,0,.85);
    display:flex;
    overflow-x:auto;
    padding:6px;
    transition:.35s;
}
#preview.show{bottom:0}
.preview-thumb{
    height:90px;
    margin-right:6px;
    cursor:pointer;
}
.preview-thumb.active{
    outline:2px solid #00ff90;
}
</style>
</head>

<body>

<div id="viewer"></div>

<button id="prev" class="nav-btn">←</button>
<button id="next" class="nav-btn">→</button>

<div id="modeBtn">下拉模式</div>
<div id="bottomBar">预览 | <span id="pageInfo">1 / 1</span></div>
<div id="preview"></div>

<script>
const seriesID = Number(new URLSearchParams(location.search).get("series")||1);

function loadData(){
    return new Promise(r=>{
        const s=document.createElement("script");
        s.src=`https://yunvgong.com/comics/menu/${seriesID}_comics_data.js`;
        s.onload=()=>r(comicData);
        document.body.appendChild(s);
    });
}

loadData().then(init);

function init(data){
    const viewer=document.getElementById("viewer");
    const preview=document.getElementById("preview");
    const pageInfo=document.getElementById("pageInfo");
    const modeBtn=document.getElementById("modeBtn");

    let pages=[], thumbs=[], state=[];
    let scrollImgs=[];
    let current=0, scrollMode=false;

    data.images.forEach((src,i)=>{
        // 翻页图
        const img=document.createElement("img");
        img.src=src;
        img.className="page-img";
        viewer.appendChild(img);
        pages.push(img);
        state.push({scale:1,x:0,y:0});

        // 预览
        const t=document.createElement("img");
        t.src=src;
        t.className="preview-thumb";
        t.onclick=()=>onPreviewClick(i);
        preview.appendChild(t);
        thumbs.push(t);
    });

    function onPreviewClick(i){
        if(scrollMode){
            const target = scrollImgs[i];
            if(target){
                target.scrollIntoView({
                    behavior:"smooth",
                    block:"start"
                });
            }
        }else{
            showPage(i);
        }
    }

    function apply(i){
        const s=state[i];
        pages[i].style.transform =
            `translate(calc(-50% + ${s.x}px), calc(-50% + ${s.y}px)) scale(${s.scale})`;
        updateNavButtons();
    }

    function showPage(i){
        current=i;
        pageInfo.innerText=`${i+1} / ${pages.length}`;
        thumbs.forEach((t,k)=>t.classList.toggle("active",k===i));
        if(scrollMode) return;
        pages.forEach(p=>p.style.display="none");
        pages[i].style.display="block";
        apply(i);
    }
    showPage(0);

    function updateNavButtons(){
        const isMobile = window.innerWidth <= 768;
        if(scrollMode){
            prev.style.display = next.style.display = "none";
            return;
        }
        if(isMobile){
            if(state[current].scale > 1){
                prev.style.display = next.style.display = "block";
            }else{
                prev.style.display = next.style.display = "none";
            }
        }else{
            prev.style.display = next.style.display = "block";
        }
    }

    prev.onclick=()=>current>0&&showPage(current-1);
    next.onclick=()=>current<pages.length-1&&showPage(current+1);

    viewer.addEventListener("wheel",e=>{
        if(scrollMode) return;
        e.preventDefault();
        state[current].scale = Math.min(5,Math.max(1,state[current].scale-e.deltaY*0.001));
        apply(current);
    },{passive:false});

    modeBtn.onclick=()=>{
        scrollMode=!scrollMode;
        modeBtn.innerText=scrollMode?"翻页模式":"下拉模式";
        viewer.innerHTML="";
        scrollImgs=[];
        if(scrollMode){
            viewer.classList.add("scroll-mode");
            viewer.style.overflowY="auto";
            data.images.forEach(src=>{
                const img=document.createElement("img");
                img.src=src;
                img.className="scroll-img";
                viewer.appendChild(img);
                scrollImgs.push(img);
            });
        }else{
            viewer.classList.remove("scroll-mode");
            viewer.style.overflow="hidden";
            pages.forEach(p=>viewer.appendChild(p));
            showPage(current);
        }
        updateNavButtons();
    };

    bottomBar.onclick=()=>preview.classList.toggle("show");
}
</script>

</body>
</html>
