<script>
const video = document.getElementById('video');
const playlist = document.getElementById('playlist');
const overlay = document.getElementById('overlay');
const bottomTitle = document.getElementById('bottom_title');
const categoryEl = document.getElementById('category');
const companyEl = document.getElementById('company');
const idcodeEl = document.getElementById('idcode');
const descriptionEl = document.getElementById('description');
const publishEl = document.getElementById('publish_date');
const actressGrid = document.getElementById('actressGrid');
let currentIndex = 0;

function getSeriesName() {
  const params = new URLSearchParams(window.location.search);
  return params.get('series') || 'default';
}

// ✅ 改成从 JSON 加载（原先是加载 .js）
function loadSeriesData(seriesName) {
  fetch(`2025/${seriesName}_data.json`)
    .then(response => {
      if (!response.ok) throw new Error("无法加载数据文件");
      return response.json();
    })
    .then(data => {
      window.episodes = data.episodes;
      window.seriesInfo = data.seriesInfo;
      initPlayer();
    })
    .catch(err => {
      alert("剧集数据加载失败: " + err.message);
    });
}

function initPlayer() {
  bottomTitle.textContent = seriesInfo.title || "剧名";
  idcodeEl.textContent = seriesInfo.IDcode || "";
  companyEl.textContent = seriesInfo.company || "";
  descriptionEl.textContent = seriesInfo.description || "";
  publishEl.textContent = seriesInfo.publish_date || "";
  categoryEl.textContent = seriesInfo.type || "";

  // ✅ 生成女优卡片
  actressGrid.innerHTML = "";
  if (Array.isArray(seriesInfo.actresses)) {
    seriesInfo.actresses.forEach(actor => {
      const card = document.createElement('div');
      card.className = "actress-card";
      card.innerHTML = `
        <a href="${actor.profile_url}" target="_blank">
          <img src="${actor.img_url}" alt="${actor.name}">
          <div class="name">${actor.name}</div>
        </a>
      `;
      actressGrid.appendChild(card);
    });
  }

  // ✅ 生成播放列表
  playlist.innerHTML = "";
  Object.entries(episodes).forEach(([ep, url], index) => {
    const btn = document.createElement('button');
    btn.textContent = ep;
    btn.onclick = () => loadEpisode(index, btn);
    playlist.appendChild(btn);
  });

  if (playlist.firstChild) {
    playlist.firstChild.classList.add('active');
    loadEpisode(0, playlist.firstChild);
  }
}

function loadEpisode(index, btn) {
  const url = Object.values(episodes)[index];
  if (!url) return;

  if (Hls.isSupported()) {
    const hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = url;
    video.addEventListener('loadedmetadata', () => video.play());
  }

  document.querySelectorAll('#playlist button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentIndex = index;
  overlay.textContent = `${seriesInfo.title} - 第${index+1}集`;
}

video.addEventListener('pause', () => overlay.style.opacity = 1);
video.addEventListener('play', () => overlay.style.opacity = 0);

loadSeriesData(getSeriesName());
</script>
